<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload Contract Documents</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    :root {
      --custom-primary-color: #00693e; /* Example: Dartmouth Green */
      --custom-light-bg: #f8f8f8;
    }
    body {
      background-color: var(--custom-light-bg);
      padding-top: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    .form-upload-container {
      max-width: 600px;
      width: 100%;
      margin: 30px auto;
      background-color: white;
      padding: 30px 40px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      border-radius: 10px;
    }
    .hero.is-primary-custom {
      background-color: var(--custom-primary-color);
      width: 100%;
    }

    .hero-body .container {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .hero .title {
      color: white;
      font-size: 2.2em;
      font-weight: 600;
      margin-left: 1.5rem;
      margin-bottom: 0;
    }

    .banner-logo {
      max-height: 70px;
      width: auto;
    }

    .file-upload-area {
      margin-bottom: 25px;
    }

    #fileNameDisplay { /* Only main file display needs this ID now */
        margin-top: 10px;
        font-style: italic;
        display: block;
        padding: 0.5em;
        border: 1px solid #dbdbdb;
        border-radius: 4px;
        background-color: #fff;
        word-wrap: break-word; /* Prevent long file names from overflowing */
    }

    #messageArea {
        margin-top: 20px;
        font-weight: bold;
    }

    #messageArea .notification {
        margin-bottom: 0; /* Prevent double margin with Bulma's default */
    }

    .button.is-primary-custom {
      background-color: var(--custom-primary-color);
      color: white;
      font-weight: bold;
    }
    .button.is-primary-custom:hover {
      background-color: #005a34;
    }

    /* Style for the example button */
    .example-button-container {
        margin-bottom: 25px; /* Space after instructions */
        text-align: center; /* Center the button */
    }


    @media (max-width: 768px) {
      .form-upload-container {
        padding: 20px;
        margin: 20px auto;
      }
      .banner-logo {
            max-height: 50px;
        }
        .hero .title {
             font-size: 1.8em;
             margin-left: 1rem; /* Adjusted for smaller screens */
        }
         .hero-body .container {
            flex-direction: column; /* Stack logo and title on small screens */
            text-align: center;
        }
        .banner-logo {
            margin-bottom: 10px; /* Space between logo and title */
        }
        .hero .title {
            margin-left: 0; /* Center title */
        }
    }
  </style>
</head>
<body>

  <section class="hero is-primary-custom is-bold">
    <div class="hero-body">
      <div class="container">
        <img src="D-Pine_Rev.png" alt="Dartmouth Logo" class="banner-logo">
        <h1 class="title">Contract Document Upload Portal</h1>
      </div>
    </div>
  </section>

  <div class="form-upload-container">
    <h2 class="title is-4 has-text-centered">Upload Your Contract Document(s)</h2>
    <p class="subtitle is-6 has-text-centered">Please provide your email and select one or more files to upload.</p>

     <div class="content" style="margin-bottom: 25px;">
        <p><strong>Please upload your final, signed contract document(s).</strong></p>
        <ul>
            <li>For **pictures** (JPG, PNG, HEIC), ensure they are **clear, readable, well-lit**, and show the **full page** without cut-offs.</li>
            <li>Please include pages showing **signatures, key terms, vehicle details, and financing information** (if applicable).</li>
            <li>You may select **multiple files** at once if your contract is in separate files or images.</li>
        </ul>
    </div>

    <div class="example-button-container">
         <p class="is-size-7" style="margin-bottom: 10px;">Click below to see an example of the financing terms page to include:</p>
         <button type="button" class="button is-link is-small" id="viewExampleButton">
            View Example Page
        </button>
    </div>
    <form id="uploadForm">
        <div class="field">
            <label class="label" for="emailInput">Your Email Address</label>
            <div class="control">
                <input class="input" type="email" id="emailInput" placeholder="e.g., user@example.com" required>
            </div>
        </div>

        <div class="field file-upload-area">
          <label class="label" for="contractFile">Contract File(s) (PDF, PNG, JPG, or HEIC accepted)</label>
          <div class="control">
            <div class="file is-boxed is-fullwidth has-name">
              <label class="file-label">
                <input class="file-input" type="file" id="contractFile" name="contractFiles[]" accept=".pdf,.png,.jpg,.jpeg,.heic,.heif,application/pdf,image/png,image/jpeg,image/heic,image/heif" multiple required>
                <span class="file-cta">
                  <span class="file-icon">
                    <i class="fas fa-upload"></i>
                  </span>
                  <span class="file-label">
                    Choose file(s)â€¦
                  </span>
                </span>
                <span class="file-name" id="fileNameDisplay">
                  No file(s) selected.
                </span>
              </label>
            </div>
          </div>
        </div>


        <div class="field">
          <div class="control">
            <button class="button is-primary-custom is-fullwidth is-medium" type="submit" id="submitButton">
              <span class="icon is-small"><i class="fas fa-cloud-upload-alt"></i></span> <span>Upload Selected File(s)</span>
            </button>
          </div>
        </div>
    </form>

    <div id="messageArea" class="content"></div>
  </div>

  <div id="exampleModal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <p class="image">
        <img src="Example_terms.png" alt="Example Financing Terms Page">
        </p>
    </div>
    <button class="modal-close is-large" aria-label="close"></button>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <script>
    $(document).ready(function() {
      const uploadForm = $('#uploadForm');
      const emailInput = $('#emailInput'); // Get reference to email input
      const contractFileInput = $('#contractFile'); // Main contract files
      const fileNameDisplay = $('#fileNameDisplay'); // Main file display
      const messageArea = $('#messageArea');
      const submitButton = $('#submitButton');

      // Get references for the modal and its trigger/close elements
      const exampleModal = $('#exampleModal');
      const viewExampleButton = $('#viewExampleButton');
      const modalBackground = $('.modal-background');
      const modalCloseButton = $('.modal-close');


      // !! IMPORTANT !!
      // REPLACE THIS WITH the Web App URL from your Apps Script deployment ("Execute as: Me", "Who has access: Anyone, even anonymous")
      // Use the URL from the DEPLOYMENT of your working Script (the one updated to handle form-urlencoded)
      const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw-qi89_2nktIW--lThd4FjZ9Egp9EXP0RxX2nTrLQp1ROuOgX1Qwgx5fTb70TV8jKCUA/exec"; // Example URL - REPLACE ME


      let filesToUpload = []; // Array to hold valid main contract File objects


      // Event listener for the main contract file input
      contractFileInput.on('change', function() {
          console.log('Main contract file input changed. Selected files:', this.files.length);
          filesToUpload = []; // Clear previous selection
          // Don't clear messageArea here, only on form submit

          if (this.files.length > 0) {
              let allFilesValid = true;
              const fileNames = [];
              const currentFiles = Array.from(this.files);

              const allowedMimeTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/heic', 'image/heif'];
              const allowedExtensionsRegex = /\.(pdf|png|jpg|jpeg|heic|heif)$/i;
              const maxSizeInBytes = 10 * 1024 * 1024; // 10MB limit per file

              for (const file of currentFiles) {
                  fileNames.push(file.name);

                  // Validate MIME type and extension
                  if (!allowedMimeTypes.includes(file.type) && !allowedExtensionsRegex.test(file.name)) {
                      messageArea.html(`<div class="notification is-danger">Error in main files: Invalid file type for "${file.name}". Only PDF, PNG, JPG, and HEIC files are accepted.</div>`);
                       messageArea.addClass('is-danger'); // Add class on error
                      allFilesValid = false;
                      break; // Stop checking further files on first error
                  }

                  // Validate file size
                  if (file.size > maxSizeInBytes) {
                      messageArea.html(`<div class="notification is-danger">Error in main files: File "${file.name}" is too large. Maximum size is ${maxSizeInBytes / (1024*1024)}MB per file.</div>`);
                       messageArea.addClass('is-danger'); // Add class on error
                      allFilesValid = false;
                      break; // Stop checking further files on first error
                  }
              }

              if (allFilesValid) {
                  // Truncate long file name list for display
                  const displayLimit = 3; // Show first 3 file names
                  const displayNames = fileNames.slice(0, displayLimit).join(', ');
                  const remainingCount = fileNames.length - displayLimit;
                  const displayText = remainingCount > 0
                      ? `${fileNames.length} file(s) selected: ${displayNames}... (+${remainingCount} more)`
                      : `${fileNames.length} file(s) selected: ${fileNames.join(', ')}`;

                  fileNameDisplay.text(displayText);
                  filesToUpload = currentFiles; // Store valid main files
                  // Clear previous file error messages if valid
                  messageArea.html('');
                  messageArea.removeClass('is-danger');

              } else {
                  // Clear selection if validation failed
                  this.value = '';
                  fileNameDisplay.text('No file(s) selected.');
                  filesToUpload = [];
                   messageArea.addClass('is-danger'); // Ensure error class is added
              }

          } else {
              fileNameDisplay.text('No file(s) selected.');
              filesToUpload = [];
               messageArea.html(''); // Clear messages if user clears selection
               messageArea.removeClass('is-danger is-success is-warning is-info');
          }
      });


      uploadForm.on('submit', function(event) {
        event.preventDefault();

        const emailAddress = emailInput.val().trim(); // Get email and trim whitespace

        // --- Frontend Validation Checks ---
        // Basic email format validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailAddress || !emailRegex.test(emailAddress)) {
             messageArea.html('<div class="notification is-warning">Please enter a valid email address.</div>');
             messageArea.addClass('is-warning');
             emailInput.focus();
             return;
        }

        // Ensure at least one main contract file is selected
        if (filesToUpload.length === 0) {
             messageArea.html('<div class="notification is-warning">Please select one or more main contract files to upload.</div>');
             messageArea.addClass('is-warning');
             contractFileInput.focus(); // Focus the main file input
             return;
        }
        // --- End Frontend Validation Checks ---


        submitButton.addClass('is-loading');
        messageArea.html('<div class="notification is-info">Reading files and preparing for upload...</div>');
        messageArea.addClass('is-info');


        // --- Prepare Data for AJAX as a JavaScript Object (jQuery will serialize as form-urlencoded) ---
        // The structure will include the email, the main files array.
        const postData = {
            emailAddress: emailAddress, // Include email in the payload
            files: [] // Array to hold main contract file data objects
            // Optional financing file data is NOT included in this form submission based on your clarification
        };

        // Only read the main contract files for upload
        const filesToRead = [...filesToUpload];


        let filesReadCount = 0;
        const totalFilesToRead = filesToRead.length; // Total number of files to read

        const readPromises = filesToRead.map(file => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                       // Extract base64 string after comma
                       const base64Data = e.target.result.split(',')[1];
                       // Default if type is empty
                       const mimeType = file.type || 'application/octet-stream';
                       const filename = file.name;

                       // Add file data as an object to the 'files' array in the postData
                       postData.files.push({
                           data: base64Data,
                           mimetype: mimeType,
                           filename: filename
                       });
                       console.log(`Finished reading contract file: "${filename}"`);


                       filesReadCount++;
                       // Optional: Update progress message as files are read
                       // messageArea.html(`<div class="notification is-info">Reading files: ${filesReadCount} of ${totalFilesToRead}...</div>`);

                       resolve(); // Resolve the promise when reading is complete
                    } catch (err) {
                       console.error('FileReader processing error for file:', file.name, err);
                       reject(`Error processing file "${file.name}": ${err.message}`);
                    }
                };
                reader.onerror = function(err) {
                    console.error('FileReader error for file:', file.name, err);
                    reject(`Failed to read file "${file.name}".`);
                };
                console.log(`Starting FileReader for file: "${file.name}"`);
                reader.readAsDataURL(file); // Read the file content as a Data URL (Base64)
            });
        });

        console.log('Starting Promise.all to read files...');

        // Wait for all files (main contract files) to be read before sending
        Promise.all(readPromises)
            .then(() => {
                 // --- All files read successfully, now send AJAX request ---
                 console.log('Promise.all resolved (all files read).');
                 // Log the structure of the object *before* jQuery serializes it
                 console.log('Object payload before AJAX send (form-urlencoded):', postData);

                 messageArea.html(`<div class="notification is-info">All files read. Sending ${totalFilesToRead} file(s)...</div>`);

                 $.ajax({
                    url: GOOGLE_SCRIPT_URL, // Use the defined script URL
                    type: 'POST', // Use POST method
                    data: postData, // Send the data as the plain object (jQuery will serialize as form-urlencoded)
                    // REMOVED: contentType: 'application/json', <-- jQuery will default to application/x-www-form-urlencoded
                    dataType: 'json', // Expect a JSON response from the server
                    timeout: 300000, // Add a timeout (e.g., 5 minutes = 300000ms)
                    success: function(data) {
                        console.log('AJAX success response:', data);
                        // Check the status in the JSON response from the script
                        if (data && data.status === 'success') {
                            messageArea.html('<div class="notification is-success">Successfully submitted. Your files have been uploaded.</div>');
                            messageArea.addClass('is-success');
                            uploadForm[0].reset(); // Reset the form
                            fileNameDisplay.text('No file(s) selected.');
                            filesToUpload = []; // Clear the stored main files
                        } else {
                            // Handle errors reported by the script (status is not 'success')
                            messageArea.html(`<div class="notification is-danger">Upload failed: ${data ? (data.message || 'Unknown error during upload.') : 'Invalid response from server.'}</div>`);
                            messageArea.addClass('is-danger');
                            console.error('Upload Error Response from server:', data);
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                         console.error('AJAX Error:', textStatus, errorThrown, jqXHR);
                         let errorMessage = 'Upload failed.';

                         if (textStatus === 'timeout') {
                             errorMessage += ' The request timed out.';
                         } else if (jqXHR.status === 0) {
                              errorMessage += ' Network error or server did not respond.';
                         } else if (jqXHR.status === 404) {
                              errorMessage += ' Server not found. Check the script URL.';
                         } else if (jqXHR.status >= 500) { // Catch 5xx server errors
                              errorMessage += ' Server error. Check the Apps Script execution logs.';
                         } else if (errorThrown === 'parsererror') {
                             errorMessage += ' Server returned invalid data. Check Apps Script logs for errors.';
                         }
                          else {
                           errorMessage += ` Status: ${jqXHR.status || 'N/A'}. Error: ${errorThrown || textStatus}`;
                         }

                         // Attempt to get more details from the server response if available
                         if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                             errorMessage += ' Details: ' + jqXHR.responseJSON.message;
                         } else if (jqXHR.responseText) {
                             try {
                                 const responseJson = JSON.parse(jqXHR.responseText);
                                 if(responseJson.message) {
                                    errorMessage += ' Details: ' + responseJson.message;
                                 } else {
                                    // Avoid logging massive responses
                                    const snippet = jqXHR.responseText.substring(0, 200);
                                    errorMessage += ' Server response snippet: ' + snippet + (jqXHR.responseText.length > 200 ? '...' : '');
                                 }
                             } catch (e) {
                                 // If responseText isn't JSON, include a snippet
                                  const snippet = jqXHR.responseText.substring(0, 200);
                                  errorMessage += ' Raw server response snippet: ' + snippet + (jqXHR.responseText.length > 200 ? '...' : '');
                             }
                         }


                         messageArea.html(`<div class="notification is-danger">${errorMessage} Please try again.</div>`);
                         messageArea.addClass('is-danger');
                       },
                    complete: function() {
                        console.log('AJAX complete.');
                        submitButton.removeClass('is-loading');
                    }
                });
            })
            .catch(errorMsg => {
                // This catch block handles errors that occurred during the file reading Promises
                console.error('File reading process error caught:', errorMsg);
                messageArea.html(`<div class="notification is-danger">Error preparing files: ${errorMsg}. Please try selecting files again.</div>`);
                messageArea.addClass('is-danger');
                submitButton.removeClass('is-loading');
            });
      });

      // --- JavaScript to control the modal ---
      viewExampleButton.on('click', function() {
          exampleModal.addClass('is-active'); // Show the modal
      });

      modalBackground.on('click', function() {
          exampleModal.removeClass('is-active'); // Hide the modal when background is clicked
      });

       modalCloseButton.on('click', function() {
          exampleModal.removeClass('is-active'); // Hide the modal when close button is clicked
       });

       // Close modal with Escape key
       $(document).on('keydown', function(event) {
           if (event.key === "Escape") {
               exampleModal.removeClass('is-active');
           }
       });
      // --- End JavaScript to control the modal ---


    });
  </script>

</body>
</html>
