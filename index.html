<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload Contract Documents</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    :root {
      --custom-primary-color: #00693e; /* Example: Dartmouth Green */
      --custom-light-bg: #f8f8f8;
    }
    body {
      background-color: var(--custom-light-bg);
      padding-top: 0; /* Remove default padding if hero is full width */
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    .form-upload-container {
      max-width: 600px;
      width: 100%;
      margin: 30px auto; /* Added margin for spacing from hero */
      background-color: white;
      padding: 30px 40px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      border-radius: 10px;
    }
    .hero.is-primary-custom { /* Custom hero class */
      background-color: var(--custom-primary-color);
      width: 100%; /* Make hero full width */
    }
    .hero-body .container .title {
      color: white;
      font-size: 2.2em;
    }
    .file-upload-area {
      margin-bottom: 25px;
    }
     /* Added styling for file name display */
    #fileNameDisplay {
        margin-top: 10px;
        font-style: italic;
        display: block; /* Ensure it takes its own line */
        padding: 0.5em;
        border: 1px solid #dbdbdb;
        border-radius: 4px;
        background-color: #fff;
    }
     /* Added styling for message area */
    #messageArea {
        margin-top: 20px;
        font-weight: bold;
    }
    .button.is-primary-custom {
      background-color: var(--custom-primary-color);
      color: white;
      font-weight: bold;
    }
    .button.is-primary-custom:hover {
      background-color: #005a34; /* Darker shade of primary */
    }
    /* Adjust padding on small screens */
    @media (max-width: 768px) {
      .form-upload-container {
        padding: 20px;
        margin: 20px auto;
      }
    }
  </style>
</head>
<body>

  <section class="hero is-primary-custom is-bold">
    <div class="hero-body">
      <div class="container has-text-centered">
        <h1 class="title">Contract Document Upload Portal</h1>
      </div>
    </div>
  </section>

  <div class="form-upload-container">
    <h2 class="title is-4 has-text-centered">Upload Your Contract</h2>
    <p class="subtitle is-6 has-text-centered">Please select a PDF or PNG file of your contract to upload.</p>

    <form id="uploadForm" method="post" action="">
        <div class="field file-upload-area">
          <label class="label">Contract File (PDF or PNG accepted)</label>
          <div class="control">
            <div class="file is-boxed is-fullwidth has-name">
              <label class="file-label">
                <input class="file-input" type="file" id="contractFile" accept=".pdf,.png,application/pdf,image/png" required>
                <span class="file-cta">
                  <span class="file-icon">
                    <i class="fas fa-upload"></i> </span>
                  <span class="file-label">
                    Choose fileâ€¦
                  </span>
                </span>
                 <span class="file-name" id="fileNameDisplay">
                  No file selected.
                </span>
              </label>
            </div>
          </div>
        </div>

        <div id="fileDataInputs"></div>

        <div class="field">
          <div class="control">
             <button class="button is-primary-custom is-fullwidth is-medium" type="submit" id="submitButton">
              <span class="icon is-small"><i class="fas fa-cloud-upload-alt"></i></span> <span>Upload Selected File</span>
            </button>
          </div>
        </div>
    </form>

    <div id="messageArea" class="content">
      </div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>
    $(document).ready(function() {
      const uploadForm = $('#uploadForm');
      const contractFileInput = $('#contractFile');
      const fileNameDisplay = $('#fileNameDisplay');
      const messageArea = $('#messageArea');
      const submitButton = $('#submitButton');
      const fileDataInputs = $('#fileDataInputs'); // The div to hold hidden inputs

      // Make sure this URL is your CORRECTLY DEPLOYED Apps Script Web App URL
      const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwgtwYV59lP7XVUe_R_wPeDFQKvnRZAXlk3H2A4_xXVtkxNbo4LIrq9ZDNYZp98_KgO/exec"; // Your actual deploy URL

      // Set the form's action URL
      uploadForm.attr('action', GOOGLE_SCRIPT_URL);


      contractFileInput.on('change', function() {
        if (this.files.length > 0) {
          const file = this.files[0]; // Get the file object
          fileNameDisplay.text(file.name);
          messageArea.html(''); // Clear previous messages
          messageArea.removeClass('is-danger is-success is-warning is-info'); // Remove Bulma notification classes


          // Client-side validation
          const allowedMimeTypes = ['application/pdf', 'image/png'];
          const allowedExtensions = /\.(pdf|png)$/i;

          // Use file.type for client-side validation MIME check
          if (!allowedMimeTypes.includes(file.type) || !allowedExtensions.test(file.name)) {
            messageArea.html('<div class="notification is-danger">Error: Invalid file type. Only PDF and PNG files are accepted.</div>');
            messageArea.addClass('is-danger');
            this.value = ''; // Reset file input
            fileNameDisplay.text('No file selected.');
            fileDataInputs.empty(); // Clear hidden inputs if file is invalid
            return;
          }

          const maxSizeInBytes = 10 * 1024 * 1024; // 10MB limit
          if (file.size > maxSizeInBytes) {
            messageArea.html(`<div class="notification is-danger">Error: File is too large. Maximum size is ${maxSizeInBytes / (1024*1024)}MB.</div>`);
             messageArea.addClass('is-danger');
            this.value = ''; // Reset file input
            fileNameDisplay.text('No file selected.');
            fileDataInputs.empty(); // Clear hidden inputs if file is too large
            return;
          }

          // Read the file and create hidden inputs
          const fr = new FileReader();
          fr.fileName = file.name; // Store filename on the reader
          fr.onload = function(e) {
              // Extract Base64 data
              const base64data = e.target.result.replace(/^.*,/, '');
              // Get MIME type directly from file object
              const mimeType = file.type;


              // Clear previous hidden inputs and append new ones
              fileDataInputs.empty().append(
                  '<input type="hidden" name="data" value="' + base64data + '" >',
                  '<input type="hidden" name="mimetype" value="' + mimeType + '" >',
                  '<input type="hidden" name="filename" value="' + e.target.fileName + '" >'
              );
          }
          fr.readAsDataURL(file); // Read file as Base64 Data URL

        } else {
          fileNameDisplay.text('No file selected.');
          fileDataInputs.empty(); // Clear hidden inputs if no file is selected
        }
      });


      // --- Form submit handler using AJAX ---
      uploadForm.on('submit', function(event) {
        event.preventDefault(); // Prevent standard form submission and page reload

        if (contractFileInput[0].files.length === 0 || fileDataInputs.is(':empty')) {
          messageArea.html('<div class="notification is-warning">Please select a file to upload and wait for it to be read.</div>');
           messageArea.addClass('is-warning');
          return;
        }

         // Re-validate just before sending (basic check based on file data inputs presence)
        const dataInput = fileDataInputs.find('input[name="data"]').val();
        const mimeInput = fileDataInputs.find('input[name="mimetype"]').val();
        const filenameInput = fileDataInputs.find('input[name="filename"]').val();

        if (!dataInput || !mimeInput || !filenameInput) {
             messageArea.html('<div class="notification is-danger">Error reading file data. Please select the file again.</div>');
             messageArea.addClass('is-danger');
             return;
        }


        submitButton.addClass('is-loading'); // Add Bulma loading class
        messageArea.html('<div class="notification is-info">Uploading, please wait...</div>');
         messageArea.addClass('is-info');

        // Collect data from hidden inputs into a plain object
        const postData = {
            data: dataInput,
            mimetype: mimeInput, // Use the value from the hidden input
            filename: filenameInput // Use the value from the hidden input
        };

        $.ajax({
          url: GOOGLE_SCRIPT_URL,
          type: 'POST',
          data: postData, // Send the plain object; jQuery will serialize it properly
          dataType: 'json',   // Expect a JSON response from the script
          success: function(data) {
            // data is the JSON object returned by the Apps Script
            if (data && data.status === 'success') {
              // --- MODIFIED: Simplified Success Message ---
              messageArea.html('<div class="notification is-success">Successfully submitted.</div>');
              // --- END MODIFIED ---
              messageArea.addClass('is-success');
              uploadForm[0].reset(); // Reset the form
              fileNameDisplay.text('No file selected.');
              fileDataInputs.empty(); // Clear hidden inputs
            } else {
              // Handle cases where status is not 'success' or data structure is unexpected
              messageArea.html(`<div class="notification is-danger">Error: ${data ? (data.message || 'Unknown error during upload.') : 'Invalid response from server.'}</div>`);
               messageArea.addClass('is-danger');
              console.error('Upload Error Response:', data);
            }
          },
          error: function(jqXHR, textStatus, errorThrown) {
            // Handle AJAX errors (network issues, script errors returning non-JSON, etc.)
            console.error('AJAX Error:', textStatus, errorThrown, jqXHR);
            let errorMessage = 'Upload failed.';
            if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                 // If the server returned JSON with a message during an error
                 errorMessage += ' Details: ' + jqXHR.responseJSON.message;
            } else if (jqXHR.responseText) {
                 // Fallback to raw text if no JSON message
                 errorMessage += ' Server response: ' + jqXHR.responseText.substring(0, 150) + '...'; // Show part of response
            } else {
                errorMessage += ' Network or server error.';
            }
            messageArea.html(`<div class="notification is-danger">${errorMessage} Please try again.</div>`);
             messageArea.addClass('is-danger');
          },
          complete: function() {
            submitButton.removeClass('is-loading'); // Remove Bulma loading class
          }
        });
      });

    }); // End of document.ready
  </script>
</body>
</html>
