<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Upload Contract Documents</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        :root {
            --custom-primary-color: #00693e; 
            --custom-light-bg: #f8f8f8;
        }
        body {
            background-color: var(--custom-light-bg);
            padding-top: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .form-upload-container, .questions-container { 
            max-width: 600px;
            width: 100%;
            margin: 30px auto;
            background-color: white;
            padding: 30px 40px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            border-radius: 10px;
        }
        .hero.is-primary-custom {
            background-color: var(--custom-primary-color);
            width: 100%;
        }

        .hero-body .container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hero .title {
            color: white;
            font-size: 2.2em;
            font-weight: 600;
            margin-left: 1.5rem;
            margin-bottom: 0;
        }

        .banner-logo {
            max-height: 70px;
            width: auto;
        }

        .file-upload-area {
            margin-bottom: 25px;
        }

        
        #selectedFilesList {
            margin-top: 10px;
            border: 1px solid #dbdbdb;
            border-radius: 4px;
            background-color: #fff;
            padding: 10px;
            min-height: 40px; 
            box-sizing: border-box;
        }

        .selected-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
            font-size: 0.9em;
            color: #4a4a4a;
        }
        .selected-file-item:last-child {
            border-bottom: none;
        }
        .selected-file-item .file-name-text {
            flex-grow: 1;
            word-break: break-all; 
            margin-right: 10px;
        }
        .selected-file-item .delete-file {
            background: none;
            border: none;
            color: #ff3860; 
            cursor: pointer;
            font-size: 1.1em;
            padding: 0 5px;
            line-height: 1;
            transition: color 0.2s ease;
        }
        .selected-file-item .delete-file:hover {
            color: #b71c1c;
        }


        #messageArea {
            margin-top: 20px;
            font-weight: bold;
        }

        #messageArea .notification {
            margin-bottom: 0; 
        }

        .button.is-primary-custom {
            background-color: var(--custom-primary-color);
            color: white;
            font-weight: bold;
        }
        .button.is-primary-custom:hover {
            background-color: #005a34;
        }

        
        .example-button-container {
            margin-bottom: 25px; 
            text-align: center; 
        }

        .file-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        
        .range-input-container {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
        .range-input-container input[type="range"] {
            flex-grow: 1;
            margin-right: 10px;
        }
        .range-input-container output {
            font-weight: bold;
            min-width: 30px; 
            text-align: right;
        }


        @media (max-width: 768px) {
            .form-upload-container, .questions-container {
                padding: 20px;
                margin: 20px auto;
            }
            .banner-logo {
                max-height: 50px;
            }
            .hero .title {
                font-size: 1.8em;
                margin-left: 1rem; 
            }
            .hero-body .container {
                flex-direction: column; 
                text-align: center;
            }
            .banner-logo {
                margin-bottom: 10px; 
            }
            .hero .title {
                margin-left: 0; 
            }
        }
    </style>
</head>
<body>

    <section class="hero is-primary-custom is-bold">
        <div class="hero-body">
            <div class="container">
                <img src="D-Pine_Rev.png" alt="Dartmouth Logo" class="banner-logo">
                <h1 class="title">Contract Document Upload Portal</h1>
            </div>
        </div>
    </section>

    <div class="form-upload-container" id="uploadFormContainer">
        <h2 class="title is-4 has-text-centered">Upload Your Contract Document(s)</h2>
        <p class="subtitle is-6 has-text-centered">Please provide your email and select one or more files to upload.</p>

        <div class="content" style="margin-bottom: 25px;">
            <h3>Instructions: How to Upload Contract Photos</h3>
            <ol>
                <li><strong>Find your car contract:</strong> Look for the papers you signed at the dealership.</li>
                <li><strong>Prepare to take photos:</strong>
                    <ol type="a">
                        <li>Go to a bright place (use daylight or a lamp).</li>
                        <li>Place the contract flat on a table.</li>
                        <li>Make sure there are no shadows, folds, or wrinkles.</li>
                    </ol>
                </li>
                <li><strong>Find the right page(s) in the contract:</strong> Look for pages that include:
                    <ol type="a">
                        <li>Dealer name and address</li>
                        <li>Vehicle details (make, model, year, VIN)</li>
                        <li>Total vehicle price</li>
                        <li>Monthly payment amount</li>
                        <li>APR (interest rate)</li>
                        <li>Loan or lease term (number of months)</li>
                        <li>Fees and taxes</li>
                        <li>Add-on products (warranty, gap insurance, paint protection, etc.)</li>
                        <li>Down payment and trade-in value</li>
                    </ol>
                </li>
                <li><strong>Look at the example:</strong> To better locate these items, please look at the sample contract by clicking "View Example Page" below.</li>
                <li><strong>Take a clear photo:</strong>
                    <ol type="a">
                        <li>Use your phone’s camera.</li>
                        <li>Hold the phone directly above the page.</li>
                        <li>Make sure the full page is in the picture, including all corners.</li>
                        <li>Do not crop or zoom in too much.</li>
                    </ol>
                </li>
                <li><strong>Take more than one photo if needed:</strong>
                    <ol type="a">
                        <li>If the contract is on multiple pages, take one photo per page.</li>
                        <li>If the page is long, take two overlapping photos.</li>
                        <li>It’s okay to send 2–5 pictures.</li>
                    </ol>
                </li>
                <li><strong>Review your photos before sending:</strong>
                    <ol type="a">
                        <li>Make sure the numbers and text are clear and easy to read.</li>
                        <li>If anything looks blurry, dark, or cut off, retake the photo.</li>
                    </ol>
                </li>
                <li><strong>Upload your photos:</strong> Send all your photos using the upload section below.</li>
            </ol>
        </div>

        <div class="example-button-container">
            <p class="is-size-7" style="margin-bottom: 10px;">Click below to see an example of pages to include:</p>
            <button type="button" class="button is-link is-medium" id="viewExampleButton">
                View Example Page
            </button>
        </div>
        <form id="uploadForm">
            <div class="field">
                <label class="label" for="emailInput">Your Email Address</label>
                <div class="control">
                    <input class="input" type="email" id="emailInput" placeholder="e.g., user@example.com" required>
                </div>
            </div>

            <div class="field file-upload-area">
                <label class="label" for="contractFile">Contract File(s) (PDF, PNG, JPG, or HEIC accepted)</label>
                <div class="control">
                    <div class="file is-boxed is-fullwidth has-name">
                        <label class="file-label">
                            <input class="file-input" type="file" id="contractFile" name="contractFiles[]" accept=".pdf,.png,.jpg,.jpeg,.heic,.heif,application/pdf,image/png,image/jpeg,image/heic,image/heif" multiple required>
                            <span class="file-cta">
                                <span class="file-icon">
                                    <i class="fas fa-upload"></i>
                                </span>
                                <span class="file-label">
                                    Choose file(s)…
                                </span>
                            </span>
                        </label>
                    </div>
                </div>
                <div id="selectedFilesList">
                    <p class="has-text-grey-light">No file(s) selected.</p>
                </div>
                <div class="file-actions">
                    <button type="button" class="button is-danger is-small is-light" id="clearAllFilesButton" style="display: none;">
                        <span class="icon is-small"><i class="fas fa-times"></i></span>
                        <span>Clear All Files</span>
                    </button>
                </div>
            </div>


            <div class="field">
                <div class="control">
                    <button class="button is-primary-custom is-fullwidth is-medium" type="submit" id="submitButton">
                        <span class="icon is-small"><i class="fas fa-cloud-upload-alt"></i></span> <span>Upload Selected File(s)</span>
                    </button>
                </div>
            </div>
        </form>

        <div id="messageArea" class="content"></div>
    </div>

    <div class="questions-container" id="questionsContainer" style="display: none;">
        <h2 class="title is-4 has-text-centered">Tell Us About Your Experience</h2>
        <p class="subtitle is-6 has-text-centered">Thank you for uploading your documents! Please answer a few quick questions about your recent car purchase.</p>

        <form id="surveyForm">
            <div class="field">
                <label class="label" for="dealSatisfaction">Overall, how satisfied are you with your car purchase deal?</label>
                <div class="control">
                    <textarea class="textarea" id="dealSatisfaction" placeholder="" rows="3" required></textarea>
                </div>
            </div>

            <div class="field">
                <label class="label" for="timeSpent">Approximately how many hours did you spend on the car purchase process (including research, dealership visits, paperwork, etc.)?</label>
                <div class="control">
                    <input class="input" type="number" id="timeSpent" min="0" step="0.5" placeholder="" required>
                </div>
            </div>

                        <div class="field">
                <label class="label" for="stressScaleHidden">On a scale of 1 to 10 (1 = Not at all stressful, 10 = Extremely stressful), how stressful was the car buying process for you?</label>
                <div class="control">
                    <div class="buttons has-addons is-centered" id="stressScaleButtonsContainer" style="flex-wrap: wrap;">
                        <button class="button" data-value="1">1</button>
                        <button class="button" data-value="2">2</button>
                        <button class="button" data-value="3">3</button>
                        <button class="button" data-value="4">4</button>
                        <button class="button" data-value="5">5</button>
                        <button class="button" data-value="6">6</button>
                        <button class="button" data-value="7">7</button>
                        <button class="button" data-value="8">8</button>
                        <button class="button" data-value="9">9</button>
                        <button class="button" data-value="10">10</button>
                    </div>
                    <input type="hidden" id="stressScaleHidden" value="0">
                </div>
            </div>
            
            <div class="field">
                <label class="label" for="numDealersPriceQuote">How many dealers did you get a car price quote from?</label>
                <div class="control">
                    <input class="input" type="number" id="numDealersPriceQuote" min="0" step="1" placeholder="" required>
                </div>
            </div>

            <div class="field">
                <label class="label" for="numDealersFinancingQuote">How many dealers did you get a financing quote from?</label>
                <div class="control">
                    <input class="input" type="number" id="numDealersFinancingQuote" min="0" step="1" placeholder="" required>
                </div>
            </div>
            
            <div class="field mt-5">
                <div class="control">
                    <button class="button is-primary-custom is-fullwidth is-medium" type="submit" id="submitSurveyButton">
                        <span class="icon is-small"><i class="fas fa-paper-plane"></i></span> <span>Submit Answers</span>
                    </button>
                </div>
            </div>
        </form>
        <div id="surveyMessageArea" class="content mt-3"></div>
    </div>


    <div id="exampleModal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <p class="image">
                <img src="1.png" alt="Example Financing Terms Page">
                </p>
        </div>
        <button class="modal-close is-large" aria-label="close"></button>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
// Function to resize an image before upload
function resizeImage(file, maxWidth, maxHeight, quality) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
            
                // Set a maximum size for the image (e.g., 1024x1024)
                if (width > height) {
                    if (width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width = Math.round(width * (maxHeight / height));
                        height = maxHeight;
                    }
                }
            
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // Get the new image as a blob
                canvas.toBlob((blob) => {
                    const resizedFile = new File([blob], file.name, {
                        type: blob.type,
                        lastModified: Date.now()
                    });
                    resolve(resizedFile);
                }, 'image/jpeg', quality); // Use a fixed quality for consistency
            };
        };
        reader.onerror = (error) => reject(error);
    });
}
    <script>
        $(document).ready(function() {
            const uploadFormContainer = $('#uploadFormContainer');
            const uploadForm = $('#uploadForm');
            const emailInput = $('#emailInput');
            const contractFileInput = $('#contractFile');
            const selectedFilesList = $('#selectedFilesList');
            const clearAllFilesButton = $('#clearAllFilesButton');
            const messageArea = $('#messageArea');
            const submitButton = $('#submitButton');

            const questionsContainer = $('#questionsContainer');
            const surveyForm = $('#surveyForm');
            const dealSatisfactionInput = $('#dealSatisfaction');
            const timeSpentInput = $('#timeSpent');
            const stressScaleButtonsContainer = $('#stressScaleButtonsContainer');
            const stressScaleHiddenInput = $('#stressScaleHidden');
            const numDealersPriceQuoteInput = $('#numDealersPriceQuote');
            const numDealersFinancingQuoteInput = $('#numDealersFinancingQuote');
            const submitSurveyButton = $('#submitSurveyButton');
            const surveyMessageArea = $('#surveyMessageArea');


            const exampleModal = $('#exampleModal');
            const viewExampleButton = $('#viewExampleButton');
            const modalBackground = $('.modal-background');
            const modalCloseButton = $('.modal-close');

           
            const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxbdFSE6SV8AIJfPJBG15nrKhNWPk8dsSdelEGWX7a-YsnyRUfem_PQlaV4Wn1sG5crEA/exec";

            
            let filesToUpload = new Map();
            let stressScaleInteracted = false;

           
            function renderSelectedFiles() {
                selectedFilesList.empty(); 

                if (filesToUpload.size === 0) {
                    selectedFilesList.append('<p class="has-text-grey-light">No file(s) selected.</p>');
                    clearAllFilesButton.hide();
                } else {
                    clearAllFilesButton.show();
                    filesToUpload.forEach((file, key) => {
                        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                        const fileItem = `
                            <div class="selected-file-item">
                                <span class="file-name-text">${file.name} (${fileSizeMB} MB)</span>
                                <button type="button" class="delete-file" data-key="${key}" title="Remove file">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </div>
                        `;
                        selectedFilesList.append(fileItem);
                    });
                }
            }

           
            selectedFilesList.on('click', '.delete-file', function() {
                const keyToRemove = $(this).data('key');
                filesToUpload.delete(keyToRemove);
                renderSelectedFiles(); 
                messageArea.html(''); 
                messageArea.removeClass('is-danger is-success is-warning is-info');
            });

            
            clearAllFilesButton.on('click', function() {
                filesToUpload.clear();
                contractFileInput.val(''); 
                renderSelectedFiles();
                messageArea.html(''); 
                messageArea.removeClass('is-danger is-success is-warning is-info');
            });


            
            contractFileInput.on('change', function() {
                console.log('Main contract file input changed. New files selected:', this.files.length);
                messageArea.html(''); 
                messageArea.removeClass('is-danger is-success is-warning is-info');

                if (this.files.length > 0) {
                    let allNewFilesValid = true;
                    const newFiles = Array.from(this.files);

                   
                    const allowedMimeTypes = ['application/pdf', 'image/png', 'image/jpg', 'image/jpeg', 'image/heic', 'image/heif'];
                    const allowedExtensionsRegex = /\.(pdf|png|jpg|jpeg|heic|heif)$/i;
                    const maxSizeInBytes = 50 * 1024 * 1024; 

                    for (const file of newFiles) {
                        const fileKey = `${file.name}-${file.size}-${file.lastModified}`;

                        if (!allowedMimeTypes.includes(file.type) && !allowedExtensionsRegex.test(file.name.toLowerCase())) {
                            messageArea.html(`<div class="notification is-danger">Error: Invalid file type for "${file.name}". Only PDF, PNG, JPG, and HEIC files are accepted.</div>`);
                            messageArea.addClass('is-danger');
                            allNewFilesValid = false;
                            break;
                        }

                        if (file.size > maxSizeInBytes) {
                            messageArea.html(`<div class="notification is-danger">Error: File "${file.name}" is too large. Maximum size is ${maxSizeInBytes / (1024*1024)}MB per file.</div>`);
                            messageArea.addClass('is-danger');
                            allNewFilesValid = false;
                            break;
                        }
                        filesToUpload.set(fileKey, file);
                    }

                    if (allNewFilesValid) {
                        renderSelectedFiles();
                        messageArea.html('');
                        messageArea.removeClass('is-danger');
                    } else {
                        
                        this.value = ''; 
                    }

                } else {
                   
                    messageArea.html('');
                    messageArea.removeClass('is-danger is-success is-warning is-info');
                }
            });


            uploadForm.on('submit', function(event) {
                event.preventDefault();

                const emailAddress = emailInput.val().trim();

                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailAddress || !emailRegex.test(emailAddress)) {
                    messageArea.html('<div class="notification is-warning">Please enter a valid email address.</div>');
                    messageArea.addClass('is-warning');
                    emailInput.focus();
                    return;
                }

                if (filesToUpload.size === 0) {
                    messageArea.html('<div class="notification is-warning">Please select one or more main contract files to upload.</div>');
                    messageArea.addClass('is-warning');
                    contractFileInput.focus();
                    return;
                }

                submitButton.addClass('is-loading');
                messageArea.html('<div class="notification is-info">Reading files and preparing for upload...</div>');
                messageArea.addClass('is-info');

                const postData = {
                    submissionType: 'contract_upload', 
                    emailAddress: emailAddress,
                    files: [] 
                };

                const filesToRead = Array.from(filesToUpload.values());
                let filesReadCount = 0;
                const totalFilesToRead = filesToRead.length;

                const readPromises = filesToRead.map(file => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                const base64Data = e.target.result.split(',')[1];
                                const mimeType = file.type || 'application/octet-stream';
                                const filename = file.name;

                                postData.files.push({
                                    data: base64Data,
                                    mimetype: mimeType,
                                    filename: filename
                                });
                                console.log(`Finished reading contract file: "${filename}"`);
                                filesReadCount++;
                                resolve();
                            } catch (err) {
                                console.error('FileReader processing error for file:', file.name, err);
                                reject(`Error processing file "${file.name}": ${err.message}`);
                            }
                        };
                        reader.onerror = function(err) {
                            console.error('FileReader error for file:', file.name, err);
                            reject(`Failed to read file "${file.name}".`);
                        };
                        console.log(`Starting FileReader for file: "${file.name}"`);
                        reader.readAsDataURL(file);
                    });
                });

                console.log('Starting Promise.all to read files...');

                Promise.all(readPromises)
                    .then(() => {
                        console.log('Promise.all resolved (all files read).');
                        console.log('Object payload before AJAX send (form-urlencoded):', postData);

                        messageArea.html(`<div class="notification is-info">All files read. Sending ${totalFilesToRead} file(s)...</div>`);

                        $.ajax({
                            url: GOOGLE_SCRIPT_URL,
                            type: 'POST',
                            data: postData,
                            dataType: 'json',
                            timeout: 300000, 
                            success: function(data) {
                                console.log('AJAX success response:', data);
                                if (data && data.status === 'success') {
                                    messageArea.html('<div class="notification is-success">Successfully uploaded your files! Please answer a few questions below.</div>');
                                    messageArea.addClass('is-success');
                                    uploadFormContainer.hide();
                                    questionsContainer.show();
                                    emailInput.prop('disabled', true);  editing
                                    filesToUpload.clear();
                                    renderSelectedFiles(); 
                                } else {
                                    messageArea.html(`<div class="notification is-danger">Upload failed: ${data ? (data.message || 'Unknown error during upload.') : 'Invalid response from server.'}</div>`);
                                    messageArea.addClass('is-danger');
                                    console.error('Upload Error Response from server:', data);
                                }
                            },
                            error: function(jqXHR, textStatus, errorThrown) {
                                console.error('AJAX Error:', textStatus, errorThrown, jqXHR);
                                let errorMessage = 'Upload failed.';

                                if (textStatus === 'timeout') {
                                    errorMessage += ' The request timed out.';
                                } else if (jqXHR.status === 0) {
                                    errorMessage += ' Network error or server did not respond.';
                                } else if (jqXHR.status === 404) {
                                    errorMessage += ' Server not found. Check the script URL.';
                                } else if (jqXHR.status >= 500) {
                                    errorMessage += ' Server error. Check the Apps Script execution logs.';
                                } else if (errorThrown === 'parsererror') {
                                    errorMessage += ' Server returned invalid data. Check Apps Script logs for errors.';
                                } else {
                                    errorMessage += ` Status: ${jqXHR.status || 'N/A'}. Error: ${errorThrown || textStatus}`;
                                }

                                if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                                    errorMessage += ' Details: ' + jqXHR.responseJSON.message;
                                } else if (jqXHR.responseText) {
                                    try {
                                        const responseJson = JSON.parse(jqXHR.responseText);
                                        if(responseJson.message) {
                                            errorMessage += ' Details: ' + responseJson.message;
                                        } else {
                                            const snippet = jqXHR.responseText.substring(0, 200);
                                            errorMessage += ' Server response snippet: ' + snippet + (jqXHR.responseText.length > 200 ? '...' : '');
                                        }
                                    } catch (e) {
                                        const snippet = jqXHR.responseText.substring(0, 200);
                                        errorMessage += ' Raw server response snippet: ' + snippet + (jqXHR.responseText.length > 200 ? '...' : '');
                                    }
                                }

                                messageArea.html(`<div class="notification is-danger">${errorMessage} Please try again.</div>`);
                                messageArea.addClass('is-danger');
                            },
                            complete: function() {
                                console.log('AJAX complete.');
                                submitButton.removeClass('is-loading');
                            }
                        });
                    })
                    .catch(errorMsg => {
                        console.error('File reading process error caught:', errorMsg);
                        messageArea.html(`<div class="notification is-danger">Error preparing files: ${errorMsg}. Please try selecting files again.</div>`);
                        messageArea.addClass('is-danger');
                        submitButton.removeClass('is-loading');
                    });
            });

            
            stressScaleButtonsContainer.on('click', '.button', function() {
                // Remove 'is-primary-custom' class from all buttons
                stressScaleButtonsContainer.find('.button').removeClass('is-primary-custom');

                // Add 'is-primary-custom' class to the clicked button
                $(this).addClass('is-primary-custom');

                // Set the value of the hidden input
                const selectedValue = $(this).data('value');
                stressScaleHiddenInput.val(selectedValue);
                stressScaleInteracted = true; // Mark as interacted

                console.log('Stress Scale selected:', selectedValue);
            });

           surveyForm.on('submit', function(event) {
                event.preventDefault();

                // Show loading indicator
                submitSurveyButton.addClass('is-loading');
                surveyMessageArea.html('<div class="notification is-info">Submitting your answers...</div>');
                surveyMessageArea.addClass('is-info');

                const emailAddressForSurvey = emailInput.val().trim(); // Get email from the first form
                const dealSatisfaction = dealSatisfactionInput.val().trim();
                const timeSpent = timeSpentInput.val();
                // NEW: Get stress scale value from the hidden input
                const stressScale = stressScaleHiddenInput.val();


                // Custom validation to ensure all required fields are filled
                if (!dealSatisfaction) {
                    surveyMessageArea.html('<div class="notification is-warning">Please tell us about your deal satisfaction.</div>');
                    surveyMessageArea.addClass('is-warning');
                    submitSurveyButton.removeClass('is-loading');
                    return;
                }

                if (timeSpent === '' || isNaN(timeSpent) || parseFloat(timeSpent) < 0) {
                     surveyMessageArea.html('<div class="notification is-warning">Please enter a valid time spent (in hours).</div>');
                     surveyMessageArea.addClass('is-warning');
                     submitSurveyButton.removeClass('is-loading');
                     return;
                }

                const numDealersPriceQuote = $('#numDealersPriceQuote').val(); // Ensure these are correctly referenced if not already constants
                if (numDealersPriceQuote === '' || isNaN(numDealersPriceQuote) || parseInt(numDealersPriceQuote) < 0) {
                     surveyMessageArea.html('<div class="notification is-warning">Please enter a valid number for car price quotes.</div>');
                     surveyMessageArea.addClass('is-warning');
                     submitSurveyButton.removeClass('is-loading');
                     return;
                }

                const numDealersFinancingQuote = $('#numDealersFinancingQuote').val(); // Ensure these are correctly referenced if not already constants
                if (numDealersFinancingQuote === '' || isNaN(numDealersFinancingQuote) || parseInt(numDealersFinancingQuote) < 0) {
                     surveyMessageArea.html('<div class="notification is-warning">Please enter a valid number for financing quotes.</div>');
                     surveyMessageArea.addClass('is-warning');
                     submitSurveyButton.removeClass('is-loading');
                     return;
                }


                // NEW: Validate that a stress scale button was actually clicked
                if (stressScale === '0' || !stressScaleInteracted) {
                    surveyMessageArea.html('<div class="notification is-warning">Please select a rating on the "Stress Scale" (1-10).</div>');
                    surveyMessageArea.addClass('is-warning');
                    submitSurveyButton.removeClass('is-loading');
                    return;
                }

                // Ensure stressScale is a valid number within range after interaction
                const parsedStressScale = parseInt(stressScale);
                if (isNaN(parsedStressScale) || parsedStressScale < 1 || parsedStressScale > 10) {
                     surveyMessageArea.html('<div class="notification is-warning">Please provide a valid stress scale rating (1-10).</div>');
                     surveyMessageArea.addClass('is-warning');
                     submitSurveyButton.removeClass('is-loading');
                     return;
                }


                const surveyPayload = {
                    submissionType: 'survey_submission',
                    emailAddress: emailAddressForSurvey,
                    dealSatisfaction: dealSatisfaction,
                    timeSpent: timeSpent,
                    stressScale: stressScale, // This now comes from the hidden input
                    numDealersPriceQuote: numDealersPriceQuote,
                    numDealersFinancingQuote: numDealersFinancingQuote
                };

                $.ajax({
                    url: GOOGLE_SCRIPT_URL,
                    type: 'POST',
                    data: surveyPayload,
                    dataType: 'json',
                    success: function(response) {
                        console.log('Survey AJAX success response:', response);
                        submitSurveyButton.removeClass('is-loading'); 

                        if (response && response.status === 'success') {
                            surveyMessageArea.html('<div class="notification is-success">Thank you for your feedback!</div>');
                            surveyMessageArea.addClass('is-success');
                            surveyForm[0].reset(); 
                        } else {
                            surveyMessageArea.html(`<div class="notification is-danger">Survey submission failed: ${response ? (response.message || 'Unknown error during submission.') : 'Invalid response from server.'}</div>`);
                            surveyMessageArea.addClass('is-danger');
                            console.error('Survey Error Response from server:', response);
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Survey AJAX Error:', textStatus, errorThrown, jqXHR);
                        let errorMessage = 'Survey submission failed.';

                        if (textStatus === 'timeout') {
                            errorMessage += ' The request timed out.';
                        } else if (jqXHR.status === 0) {
                            errorMessage += ' Network error or server did not respond.';
                        } else if (jqXHR.status === 404) {
                            errorMessage += ' Server not found. Check the script URL.';
                        } else if (jqXHR.status >= 500) {
                            errorMessage += ' Server error. Check the Apps Script execution logs.';
                        } else if (errorThrown === 'parsererror') {
                            errorMessage += ' Server returned invalid data. Check Apps Script logs for errors.';
                        } else {
                            errorMessage += ` Status: ${jqXHR.status || 'N/A'}. Error: ${errorThrown || textStatus}`;
                        }

                        if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                            errorMessage += ' Details: ' + jqXHR.responseJSON.message;
                        } else if (jqXHR.responseText) {
                            try {
                                const responseJson = JSON.parse(jqXHR.responseText);
                                if(responseJson.message) {
                                    errorMessage += ' Details: ' + responseJson.message;
                                } else {
                                    const snippet = jqXHR.responseText.substring(0, 200);
                                    errorMessage += ' Raw server response snippet: ' + snippet + (jqXHR.responseText.length > 200 ? '...' : '');
                                }
                            } catch (e) {
                                const snippet = jqXHR.responseText.substring(0, 200);
                                errorMessage += ' Raw server response snippet: ' + snippet + (jqXHR.responseText.length > 200 ? '...' : '');
                            }
                        }

                        surveyMessageArea.html(`<div class="notification is-danger">${errorMessage} Please try again.</div>`);
                        surveyMessageArea.addClass('is-danger');
                    },
                    complete: function() {
                        submitSurveyButton.removeClass('is-loading');
                    }
                });
            });

            
            viewExampleButton.on('click', function() {
                exampleModal.addClass('is-active');
            });

            modalBackground.on('click', function() {
                exampleModal.removeClass('is-active');
            });

            modalCloseButton.on('click', function() {
                exampleModal.removeClass('is-active');
            });

            
            renderSelectedFiles();
        });
    </script>
</body>
</html>
